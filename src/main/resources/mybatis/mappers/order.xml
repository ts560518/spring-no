<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.OrderDao">
	<!-- 예매페이지에서 사용할 쿠폰내역 -->
	<select id="getUserCoupon" parameterType="int" resultType="UserCoupon">
		select
			A.COUPON_HISTORY_NO			AS historyNo,
			A.COUPON_NO					AS no,
			A.USER_NO					AS userNo,
			A.COUPON_DISABLED			AS disabled,
			A.COUPON_USED_DATE			AS usedDate,
			B.COUPON_NAME				AS name,
			B.COUPON_PRICE				AS price,
			B.COUPON_START_DATE			AS startDate,
			B.coupon_end_date			AS endDate,
			B.COUPON_STATUS				AS status
		from
			SHOW_COUPON_HISTORIES A, SHOW_COUPONS B
		where
			USER_NO = #{value}
			and A.COUPON_NO = B.COUPON_NO
			and B.COUPON_STATUS = 'N'
			and A.COUPON_DISABLED = 'N'
	</select>
	
	<!-- 쿠폭입력시 쿠폰 가격조회 -->
	<select id="getCouponPrice" parameterType="int" resultType="Coupon">
		select
			COUPON_NO					AS no,
			COUPON_NAME					AS name,
			COUPON_PRICE				AS price,
			COUPON_START_DATE			AS startDate,
			coupon_end_date			AS endDate,
			COUPON_STATUS				AS status
		from
			SHOW_COUPONS
		where
			COUPON_NO = #{value}
	</select>
	
	<!-- 쿠폰사용시 업데이트 -->
	<update id="updateCoupon" parameterType="int">
		update SHOW_COUPON_HISTORIES
		SET
			coupon_disabled = 'Y',
			COUPON_USED_DATE = SYSDATE
		WHERE
			COUPON_NO = #{value}
	</update>
	
	<!-- 예매좌석 테이블 업데이트 -->
	<update id="updateShowSeat" parameterType="map">
		update show_seat
		set
			TICKET='Y'
		WHERE
			show_seat_no = #{seatNo}
			and
			put_show_no = #{putShowNo}
	</update>
	
	<!-- 유저 포인트 내역 추가 -->
	<insert id="insertPointHistories">
		insert into show_user_point_histories
		(history_no, user_no, point_amount, point_content)
		values
		(show_user_point_histories_seq.nextval,#{userNo}, #{pointAmount}, #{content})
	</insert>
	
	<!-- 은행정보 조회 -->
	<select id="getBank" parameterType="string" resultType="Bank">
		select 
			bank_no		as no,
			bank_name	as name
		from
			show_bank_card_companies
		where
			bank_name=#{value}
	</select>
	
	<!-- 예매시퀀스 번호 조회 -->
	<select id="getOrderNo" resultType="int">
		select show_ticket_orders_seq.nextval seq from dual
	</select>
	
	<!-- 예매 -->
	<insert id="insertOrder" parameterType="Order">
		insert into show_ticket_orders
			(order_no, user_no, put_show_no, order_amount, order_status, total_order_price, 
			used_point, total_payment_price, order_payment_method, bank_no, bank_card_account, coupon_history_no)
			values
			(#{no}, #{userNo} ,#{putShowNo},#{orderAmount},#{status},#{totalOrderPrice},#{usedPoint},
			#{totalPaymentPrice},#{orderPaymentMethod},#{bankNo},#{bankCardAccount},
			<if test="couponHistoryNo!=0">
				#{couponHistoryNo})
			</if>
			<if test="couponHistoryNo==0">
				null)
			</if>
	</insert>
	
	<!-- 예매에 대한 내역 조회 테이블에 데이터 넣기 -->
	<insert id="insertTicketOrderItems" parameterType="map">
		insert into show_ticket_order_items
		(order_item_no, order_no, seat_no)
		values
		(show_ticket_order_items_seq.nextval, #{orderNo}, #{seatNo})
	</insert>
	
	<select id="getAllAboutOrder" parameterType="int" resultType="OrderDto" >
		select
			A.ORDER_NO as "order.no",
			A.USER_NO as "order.userNo",
			A.PUT_SHOW_NO as "order.putShowNo",
			A.ORDER_AMOUNT as "order.orderAmout",
			A.ORDER_STATUS as "order.status",
			A.TOTAL_ORDER_PRICE as "order.totalOrderPrice",
			A.USED_POINT as "order.usedPoint",
			A.TOTAL_PAYMENT_PRICE as "order.totalPaymentPrice",
			A.ORDER_PAYMENT_METHOD as "order.orderPaymentMethod",
			A.BANK_NO as "order.bankNo",
			A.BANK_CARD_ACCOUNT as "order.bankCardAccount",
			A.ORDER_CREATED_DATE as "order.createdDate",
			A.COUPON_HISTORY_NO as "order.couponHistoryNo",
			
			B.ORDER_ITEM_NO as itemNo,
			B.SEAT_NO as "showSeat.no",
			
			C.user_no as "user.no",
			C.user_name as "user.name",
			C.user_id as "user.id",
			C.user_password as "user.password",
			C.user_birth as "user.birth",
			C.user_tel as "user.tel",
			C.user_email as "user.email",
			C.user_address as "user.address",
			C.email_receiving_consent as "user.emailReceivingConsent",
			C.sms_receiving_consent as "user.smsReceivingConsent",
			C.user_available_point as "user.availablePoint",
			C.user_created_date as "user.createdDate",
			
			D.PUT_SHOW_NO as "putShows.putShowNo",
			D.SHOW_NO as "putShows.showNo",
			D.SHOW_DAY as "putShows.day",
			D.SHOW_START_TIME as "putShows.startTime",
			
			E.show_no as "show.no",
			E.category_no as "show.categoryNo",
			E.show_name as "show.name",
			E.viewing_no as "show.viewingNo",
			E.running_time as "show.runningTime",
			E.poster_img as "show.posterImg",
			E.begin_date as "show.beginDate",
			E.end_date as "show.endDate",
			E.place_no as "show.placeNo",
			E.attention_img as "show.attentionImg",
			E.sale_img as "show.saleImg",
			E.show_detail_img as "show.showDetailImg",
			E.show_created_date as "show.createdDate",
			
			F.HISTORY_NO as "point.no",
			F.POINT_AMOUNT as "point.pointAmount",
			F.POINT_CONTENT as "point.content",
			F.POINT_CREATED_DATE as "point.createdDate",
			
			G.COUPON_NO as "coupon.no",
			G.COUPON_NAME as "coupon.name",
			G.COUPON_PRICE as "coupon.price",
			G.COUPON_START_DATE as "coupon.startDate",
			G.COUPON_END_DATE as "coupon.endDate",
			G.COUPON_STATUS as "coupon.status",
			
			H.coupon_history_no as "userCoupon.historyNo",
			H.coupon_disabled as "userCoupon.disabled",
			H.coupon_used_date as "userCoupon.usedDate",
			
			I.show_seat_no as "showSeat.showSeatNo",
			I.ticket as "showSeat.ticket"
		from
			show_ticket_orders A, show_ticket_order_items B, show_users C, show_put_shows D, shows E, show_user_point_histories F, show_coupons G, show_coupon_histories H, show_seat I
		where
			A.order_no = B.order_no
		and
			A.user_no = C.user_no
		and
			A.put_show_no = D.put_show_no
		and
			C.user_no = F.user_no
		and
			C.user_no = H.user_no
		and
			D.show_no = E.show_no
		and
			D.put_show_no = I.put_show_no
		and
			G.coupon_no = H.coupon_no
		and
			A.user_no = #{userNo}
	</select>
	
	<select id="getCountOrderByUserNo" parameterType="int" resultType="int">
		select count(*)
		from
			show_ticket_orders
		where
			user_no = #{userNo}
	</select>
</mapper>